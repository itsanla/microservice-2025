version: '3.8'

services:
  # ==================== PRODUK SERVICE ====================
  produk-service:
    image: itsanla/produk:latest
    container_name: produk-service
    ports:
      - "8081:8081"
    environment:
      SERVER_PORT: 8081
      SPRING_APPLICATION_NAME: PRODUK-SERVICE
      
      # Eureka Configuration
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://${EUREKA_IP}:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: "true"
      EUREKA_INSTANCE_IP_ADDRESS: ${VPS_MARKETPLACE_IP}
      
      # H2 Database
      SPRING_DATASOURCE_URL: jdbc:h2:file:/app/data/produk;DB_CLOSE_ON_EXIT=FALSE;AUTO_RECONNECT=TRUE
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.h2.Driver
      SPRING_DATASOURCE_USERNAME: sa
      SPRING_DATASOURCE_PASSWORD: password
      SPRING_H2_CONSOLE_ENABLED: "true"
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      
      # Logging to ELK
      LOGSTASH_HOST: ${LOGSTASH_IP}
      LOGSTASH_PORT: 5000
    volumes:
      - produk-data:/app/data
    networks:
      - marketplace-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==================== PELANGGAN SERVICE ====================
  pelanggan-service:
    image: itsanla/pelanggan:latest
    container_name: pelanggan-service
    ports:
      - "8082:8082"
    environment:
      SERVER_PORT: 8082
      SPRING_APPLICATION_NAME: PELANGGAN-SERVICE
      
      # Eureka Configuration
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://${EUREKA_IP}:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: "true"
      EUREKA_INSTANCE_IP_ADDRESS: ${VPS_MARKETPLACE_IP}
      
      # H2 Database
      SPRING_DATASOURCE_URL: jdbc:h2:file:/app/data/pelanggan;DB_CLOSE_ON_EXIT=FALSE;AUTO_RECONNECT=TRUE
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.h2.Driver
      SPRING_DATASOURCE_USERNAME: sa
      SPRING_DATASOURCE_PASSWORD: password
      SPRING_H2_CONSOLE_ENABLED: "true"
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      
      # RabbitMQ Configuration
      SPRING_RABBITMQ_HOST: ${RABBITMQ_IP}
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USER}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      
      # Logging to ELK
      LOGSTASH_HOST: ${LOGSTASH_IP}
      LOGSTASH_PORT: 5000
    volumes:
      - pelanggan-data:/app/data
    networks:
      - marketplace-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==================== ORDER SERVICE ====================
  order-service:
    image: itsanla/order:latest
    container_name: order-service
    ports:
      - "8083:8083"
    environment:
      SERVER_PORT: 8083
      SPRING_APPLICATION_NAME: ORDER-SERVICE
      
      # Eureka Configuration
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://${EUREKA_IP}:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: "true"
      EUREKA_INSTANCE_IP_ADDRESS: ${VPS_MARKETPLACE_IP}
      
      # H2 Database
      SPRING_DATASOURCE_URL: jdbc:h2:file:/app/data/order;DB_CLOSE_ON_EXIT=FALSE;AUTO_RECONNECT=TRUE
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.h2.Driver
      SPRING_DATASOURCE_USERNAME: sa
      SPRING_DATASOURCE_PASSWORD: password
      SPRING_H2_CONSOLE_ENABLED: "true"
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      
      # RabbitMQ Configuration
      SPRING_RABBITMQ_HOST: ${RABBITMQ_IP}
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USER}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      
      # Logging to ELK
      LOGSTASH_HOST: ${LOGSTASH_IP}
      LOGSTASH_PORT: 5000
    volumes:
      - order-data:/app/data
    networks:
      - marketplace-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  produk-data:
    driver: local
  pelanggan-data:
    driver: local
  order-data:
    driver: local

networks:
  marketplace-network:
    driver: bridge
